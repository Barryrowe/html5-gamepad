<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>html5-gamepad Test Page</title>
</head>
<body>
	<h1><a href="https://github.com/ericlathrop/html5-gamepad">html5-gamepad</a> Test Page</h1>
	<p><button id="map">Map the controller</button></p>
	<p>Connect a gamepad and press a button on it.</p>
	<pre>
		<div id="content"></div>
	</pre>
	<script type="text/javascript" src="index.js"></script>
	<script>
		var g = new Gamepad();
		var unmapped = new Gamepad([{
			buttons: [],
			axes: []
		}]);

		function getPushedButtonIndex(gamepad) {
			var idx = undefined;
			Object.keys(gamepad.gamepads[0].buttons).forEach(function(key, i) {
				if (gamepad.gamepads[0].buttons[key] === true) {
					idx = i;
				}
			});
			return idx;
		}
		function getPushedAxisIndex(gamepad) {
			var idx = undefined;
			Object.keys(gamepad.gamepads[0].axes).forEach(function(key, i) {
				if (gamepad.gamepads[0].axes[key] > 0.5) {
					idx = i;
				}
			});
			return idx;
		}
		function collectMappings(gamepad) {
			if (gamepad.count() === 0) {
				return;
			}

			if (step === "prompt") {
				console.log("Press the \"" + buttons[currentButton] + "\" button");
				step = "collect";
			}
			var a = getPushedAxisIndex(gamepad);
			var b = getPushedButtonIndex(gamepad);
			if (step === "collect" && a !== undefined) {
				console.log("received axis " + a);
				mapping.axes[a] = {
					name: buttons[currentButton],
					scale: "to positive",
					buttons: [
						null,
						buttons[currentButton]
					]
				};
				step = "release";
			}
			if (step === "collect" && b !== undefined) {
				console.log("received button " + b);
				mapping.buttons[b] = {
					name: buttons[currentButton]
				};
				step = "release";
			}
			if (step === "release" && a === undefined && b === undefined) {
				if (currentButton < buttons.length - 1) {
					currentButton++;
					step = "prompt";
				} else {
					console.log("done");
					console.log(mapping);
					step = "done";
				}
			}
		}

		function render() {
			g.update();
			unmapped.update();
			collectMappings(unmapped);

			document.getElementById("content").innerHTML = JSON.stringify(unmapped.gamepads, null, 2);
			window.requestAnimationFrame(render);
		}
		window.requestAnimationFrame(render);

		var buttons = [
			"a",
			"b",
			"x",
			"y",
			"back",
			"start",
			"home",
			"left shoulder",
			"right shoulder",
			"left trigger",
			"right trigger",
			"left stick",
			"right stick",
		];
		var currentButton = 0;
		var step = "done";
		var mapping;
		document.getElementById("map").addEventListener("click", function() {
			currentButton = 0;
			step = "prompt";
			mapping = {
				buttons: [],
				axes: []
			};
		});
	</script>
</body>
</html>
